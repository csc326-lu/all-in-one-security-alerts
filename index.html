<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Security Alerts</title>

  <!-- Makes it behave more like an iPhone app when added to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alerts">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; background: #f3f4f6; }
    header { position: sticky; top: 0; background: white; padding: 14px 16px; border-bottom: 1px solid #e5e7eb; }
    h1 { margin: 0; font-size: 18px; }
    .sub { margin-top: 6px; font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; gap: 10px; }
    .pill { padding: 4px 10px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px; }
    main { padding: 12px 12px 24px; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .msg { font-size: 15px; margin: 0 0 8px; }
    .meta { font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; gap: 10px; }
    .btnrow { display: flex; gap: 10px; margin-top: 10px; }
    button { border: 1px solid #d1d5db; background: white; padding: 10px 12px; border-radius: 10px; font-size: 14px; }
    button:active { transform: scale(0.99); }
    .error { color: #b91c1c; }
    .ok { color: #065f46; }
    .muted { color: #6b7280; }
    .empty { text-align: center; padding: 28px 12px; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <h1>Security Alerts</h1>
    <div class="sub">
      <div id="status" class="pill muted">Loading…</div>
      <div class="pill">Auto refresh: <span id="intervalLabel">2</span>s</div>
    </div>
    <div class="btnrow">
      <button id="refreshBtn">Refresh now</button>
      <button id="clearLocalBtn" title="Hides alerts locally (does not delete Firebase)">Clear on screen</button>
    </div>
  </header>

  <main>
    <div id="list"></div>
    <div id="empty" class="empty" style="display:none;">
      No alerts yet.<br><br>
      Trigger your system or wait for the next alert.
    </div>
  </main>

<script>
  // ========= CONFIG =========
  const DB_BASE = "https://all-in-one-security-system-default-rtdb.firebaseio.com";
  const ALERTS_URL = `${DB_BASE}/alerts.json`;
  let REFRESH_SECONDS = 2; // auto refresh interval
  const MAX_ITEMS = 50;    // show newest 50
  // ==========================

  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  const intervalLabelEl = document.getElementById("intervalLabel");

  intervalLabelEl.textContent = REFRESH_SECONDS;

  // Keep track of items hidden locally (so "Clear on screen" works without deleting Firebase)
  const HIDDEN_KEY = "hiddenAlertKeys";
  const hiddenKeys = new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY) || "[]"));

  function saveHidden() {
    localStorage.setItem(HIDDEN_KEY, JSON.stringify(Array.from(hiddenKeys)));
  }

  function setStatus(text, kind) {
    statusEl.textContent = text;
    statusEl.classList.remove("error", "ok", "muted");
    if (kind) statusEl.classList.add(kind);
    else statusEl.classList.add("muted");
  }

  function formatTs(ts) {
    // If ts is epoch seconds (NTP), it will be ~1,700,000,000
    // If ts is millis since boot, it will be smaller.
    const n = Number(ts);
    if (!isFinite(n) || n <= 0) return "time unknown";

    // If it looks like epoch seconds, convert to ms
    const ms = (n > 1577836800) ? (n * 1000) : n;
    const d = new Date(ms);
    if (isNaN(d.getTime())) return String(ts);

    return d.toLocaleString();
  }

  function renderItems(items) {
    listEl.innerHTML = "";
    const visible = items.filter(x => !hiddenKeys.has(x.key));

    if (visible.length === 0) {
      emptyEl.style.display = "block";
      return;
    }
    emptyEl.style.display = "none";

    for (const item of visible) {
      const card = document.createElement("div");
      card.className = "card";

      const msg = document.createElement("p");
      msg.className = "msg";
      msg.textContent = item.msg || "(no message)";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span class="muted">${formatTs(item.ts)}</span>
        <span class="muted">id: ${item.key}</span>
      `;

      const btnRow = document.createElement("div");
      btnRow.className = "btnrow";

      const hideBtn = document.createElement("button");
      hideBtn.textContent = "Hide";
      hideBtn.onclick = () => {
        hiddenKeys.add(item.key);
        saveHidden();
        loadAlerts();
      };

      btnRow.appendChild(hideBtn);

      card.appendChild(msg);
      card.appendChild(meta);
      card.appendChild(btnRow);

      listEl.appendChild(card);
    }
  }

  async function loadAlerts() {
    try {
      setStatus("Refreshing…", "muted");

      // We use shallow fetch then parse; Firebase returns { key: {msg, ts, ...}, ... } or null.
      const res = await fetch(ALERTS_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();

      if (!data) {
        renderItems([]);
        setStatus("Connected (no alerts)", "ok");
        return;
      }

      // Convert to array and sort newest first by ts (fallback to 0)
      const items = Object.entries(data).map(([key, val]) => ({
        key,
        msg: val?.msg ?? "",
        ts: val?.ts ?? 0
      }));

      items.sort((a, b) => Number(b.ts || 0) - Number(a.ts || 0));

      renderItems(items.slice(0, MAX_ITEMS));
      setStatus(`Connected • ${items.length} total`, "ok");
    } catch (e) {
      console.error(e);
      setStatus("Error loading alerts", "error");
    }
  }

  document.getElementById("refreshBtn").onclick = loadAlerts;

  document.getElementById("clearLocalBtn").onclick = () => {
    // Hide everything currently shown without deleting from Firebase
    const cards = listEl.querySelectorAll(".card");
    cards.forEach(c => {
      const idText = c.querySelector(".meta")?.textContent || "";
      // Not perfect parsing, but we also just reload after hiding all known keys:
    });

    // Safer: fetch, hide all keys found, then reload
    (async () => {
      try {
        const res = await fetch(ALERTS_URL, { cache: "no-store" });
        const data = await res.json();
        if (data) {
          Object.keys(data).forEach(k => hiddenKeys.add(k));
          saveHidden();
        }
        loadAlerts();
      } catch {}
    })();
  };

  // Initial load + auto refresh
  loadAlerts();
  setInterval(loadAlerts, REFRESH_SECONDS * 1000);
</script>
</body>
</html>
