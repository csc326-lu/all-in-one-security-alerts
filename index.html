<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Security Alerts</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alerts">

  <style>
    :root{
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --pill-bg: #eef2ff;
      --pill-text: #3730a3;
      --btn-bg: #ffffff;
      --btn-border: #d1d5db;
      --btn-text: #111827;
      --error: #b91c1c;
      --ok: #065f46;
      --warn: #92400e;

      /* NEW: alert type colors (light mode) */
      --alert-info: #2563eb;       /* blue */
      --alert-online: #16a34a;     /* green */
      --alert-vibration: #9333ea;  /* purple */
      --alert-temperature: #ea580c;/* orange */
      --alert-water: #0284c7;      /* cyan/blue */
      --alert-gas: #dc2626;        /* red */
    }

    body.dark {
      --bg: #0b1220;
      --surface: #0f172a;
      --border: #243044;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --pill-bg: #1f2937;
      --pill-text: #c7d2fe;
      --btn-bg: #0b1220;
      --btn-border: #243044;
      --btn-text: #e5e7eb;
      --error: #fca5a5;
      --ok: #86efac;
      --warn: #fbbf24;

      /* NEW: alert type colors (dark mode) */
      --alert-info: #60a5fa;
      --alert-online: #4ade80;
      --alert-vibration: #c084fc;
      --alert-temperature: #fb923c;
      --alert-water: #38bdf8;
      --alert-gas: #f87171;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      background: var(--surface);
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      z-index: 5;
    }
    h1 { margin: 0; font-size: 18px; }
    .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-text);
      font-size: 12px;
      border: 1px solid var(--border);
      white-space: nowrap;
    }

    main { padding: 12px 12px 24px; max-width: 980px; margin: 0 auto; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px){
      .grid { grid-template-columns: 360px 1fr; align-items: start; }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .msg { font-size: 15px; margin: 0 0 8px; }
    .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btnrow { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button {
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    button:active { transform: scale(0.99); }
    button.primary { background: var(--pill-bg); border-color: var(--border); }
    button.danger { border-color: #ef4444; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    input, select {
      width: 100%;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
    }
    label { display: block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }

    .error { color: var(--error); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .muted { color: var(--muted); }
    .empty { text-align: center; padding: 28px 12px; color: var(--muted); }

    .divider { height: 1px; background: var(--border); margin: 12px 0; }

    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .linkbtn{
      background: none;
      border: none;
      padding: 0;
      color: var(--pill-text);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
    }

    /* =========================================================
       NEW: Distinct alert styling
       ========================================================= */
    .alertCard{
      position: relative;
      border-left: 6px solid var(--border);
    }
    .alertTop{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .alertBadge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--pill-bg);
      color: var(--pill-text);
      white-space: nowrap;
    }
    .alertBadge .emoji{ font-size: 14px; line-height: 1; }

    /* Type-specific: border + subtle tint */
    .alert--info{ border-left-color: var(--alert-info); background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(0,0,0,0) 45%); }
    body.dark .alert--info{ background: linear-gradient(90deg, rgba(96,165,250,0.10), rgba(0,0,0,0) 45%); }

    .alert--online{ border-left-color: var(--alert-online); background: linear-gradient(90deg, rgba(22,163,74,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--online{ background: linear-gradient(90deg, rgba(74,222,128,0.10), rgba(0,0,0,0) 45%); }

    .alert--vibration{ border-left-color: var(--alert-vibration); background: linear-gradient(90deg, rgba(147,51,234,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--vibration{ background: linear-gradient(90deg, rgba(192,132,252,0.10), rgba(0,0,0,0) 45%); }

    .alert--temperature{ border-left-color: var(--alert-temperature); background: linear-gradient(90deg, rgba(234,88,12,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--temperature{ background: linear-gradient(90deg, rgba(251,146,60,0.10), rgba(0,0,0,0) 45%); }

    .alert--water{ border-left-color: var(--alert-water); background: linear-gradient(90deg, rgba(2,132,199,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--water{ background: linear-gradient(90deg, rgba(56,189,248,0.10), rgba(0,0,0,0) 45%); }

    .alert--gas{ border-left-color: var(--alert-gas); background: linear-gradient(90deg, rgba(220,38,38,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--gas{ background: linear-gradient(90deg, rgba(248,113,113,0.10), rgba(0,0,0,0) 45%); }
  </style>
</head>

<body>
  <header>
    <h1>Security Alerts</h1>
    <div class="sub">
      <div id="status" class="pill muted">Loadingâ€¦</div>
      <div class="pill">Auto refresh: <span id="intervalLabel">2</span>s</div>
      <div class="pill">User: <span id="userLabel" class="mono">â€”</span></div>
    </div>

    <div class="btnrow">
      <button id="refreshBtn">Refresh now</button>
      <button id="clearLocalBtn" title="Hides alerts locally (does not delete Firebase)">Clear on screen</button>
      <button id="themeBtn" title="Toggle night mode">Night mode: Off</button>
      <button id="logoutBtn" class="danger" style="margin-left:auto; display:none;">Log out</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Auth + Pairing -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Account</h3>

        <!-- LOGIN VIEW -->
        <div id="loginView">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="name@example.com" autocomplete="email"/>

          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>

          <div class="btnrow">
            <button id="loginBtn" class="primary">Log in</button>
            <button id="goSignupBtn">Create account</button>
          </div>

          <div class="divider"></div>

          <label>Forgot password?</label>
          <input id="resetEmail" type="email" placeholder="Email to send reset link" autocomplete="email"/>
          <div class="btnrow">
            <button id="resetBtn">Send reset email</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            Password reset uses Firebase Auth email reset (free). Check spam/junk folders.
          </p>
        </div>

        <!-- SIGNUP VIEW -->
        <div id="signupView" style="display:none;">
          <p class="small muted" style="margin:0 0 8px;">
            Create a new account for the alerts dashboard.
          </p>

          <label>Email</label>
          <input id="signupEmail" type="email" placeholder="name@example.com" autocomplete="email"/>

          <label>Password</label>
          <input id="signupPassword" type="password" placeholder="Create a password" autocomplete="new-password"/>

          <label>Confirm Password</label>
          <input id="signupPassword2" type="password" placeholder="Confirm password" autocomplete="new-password"/>

          <div class="btnrow">
            <button id="signupBtn" class="primary">Create account</button>
            <button id="backToLoginBtn">Back to login</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            After creating an account, you will be logged in automatically.
          </p>
        </div>

        <!-- PAIRED / LOGGED-IN PANEL -->
        <div id="pairPanel" style="display:none;">
          <h3 style="margin:0 0 8px;">Pair a device</h3>
          <p class="small muted" style="margin:0 0 8px;">
            Enter the Device ID + Pairing Code shown on the ESP8266 AP page.
          </p>

          <label>Device ID</label>
          <input id="deviceId" placeholder="Example: SystemA" />

          <label>Pairing Code</label>
          <input id="pairCode" placeholder="Example: 839201" />

          <div class="btnrow">
            <button id="pairBtn" class="primary">Pair device</button>
          </div>

          <div class="divider"></div>

          <label>Your paired devices</label>
          <select id="deviceSelect"></select>

          <div class="btnrow">
            <button id="reloadDevicesBtn">Reload devices</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            Pairing is saved to your account in Firebase, so you can log out/in and keep access.
          </p>

          <!-- NEW: Manage/Delete paired devices -->
          <div class="divider"></div>

          <h3 style="margin:0 0 8px;">Manage paired devices</h3>
          <p class="small muted" style="margin:0 0 8px;">
            Deleting a device here removes it from <span class="mono">your account</span> only. It does not delete alerts in Firebase.
          </p>

          <label>Delete a paired device</label>
          <select id="deleteDeviceSelect"></select>

          <div class="btnrow">
            <button id="deleteDeviceBtn" class="danger">Delete device</button>
          </div>
          <!-- END NEW -->
        </div>

        <div class="divider"></div>
        <p id="authMsg" class="small muted" style="margin:0;"></p>
      </div>

      <!-- RIGHT: Alerts -->
      <div>
        <div id="list"></div>
        <div id="empty" class="empty" style="display:none;">
          No alerts yet.<br><br>
          Trigger your system or wait for the next alert.
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // Firebase SDK (v10 modular) via CDN modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getDatabase,
      ref,
      get,
      set,
      remove,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ========= YOUR FIREBASE WEB CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyBk7o8KHY3qH3kCy-566j4_UKna8qkF0fM",
      authDomain: "all-in-one-security-system.firebaseapp.com",
      databaseURL: "https://all-in-one-security-system-default-rtdb.firebaseio.com",
      projectId: "all-in-one-security-system",
      storageBucket: "all-in-one-security-system.firebasestorage.app",
      messagingSenderId: "503460021077",
      appId: "1:503460021077:web:ffbaa186aeb34a749ce5dc"
    };

    // ========= UI CONFIG =========
    let REFRESH_SECONDS = 2;
    const MAX_ITEMS = 50;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const intervalLabelEl = document.getElementById("intervalLabel");
    const userLabelEl = document.getElementById("userLabel");
    const logoutBtn = document.getElementById("logoutBtn");
    const authMsg = document.getElementById("authMsg");

    const loginView = document.getElementById("loginView");
    const signupView = document.getElementById("signupView");
    const pairPanel = document.getElementById("pairPanel");

    const deviceSelect = document.getElementById("deviceSelect");

    // delete UI refs
    const deleteDeviceSelect = document.getElementById("deleteDeviceSelect");
    const deleteDeviceBtn = document.getElementById("deleteDeviceBtn");

    intervalLabelEl.textContent = REFRESH_SECONDS;

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.classList.remove("error", "ok", "muted", "warn");
      statusEl.classList.add(kind || "muted");
    }

    function setAuthMsg(text, kind){
      authMsg.textContent = text || "";
      authMsg.classList.remove("error","ok","muted","warn");
      authMsg.classList.add(kind || "muted");
    }

    function showAuthView(which){
      // which = "login" | "signup"
      if (which === "signup"){
        loginView.style.display = "none";
        signupView.style.display = "block";
      } else {
        signupView.style.display = "none";
        loginView.style.display = "block";
      }
      pairPanel.style.display = "none";
    }

    function formatTs(ts) {
      const n = Number(ts);
      if (!isFinite(n) || n <= 0) return "time unknown";
      const ms = (n > 1577836800) ? (n * 1000) : n; // epoch seconds -> ms
      const d = new Date(ms);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    }

    // ---------- Local hide (per device) ----------
    function hiddenKeyForDevice(deviceId){ return `hiddenAlertKeys:${deviceId}`; }
    function loadHiddenSet(deviceId){
      return new Set(JSON.parse(localStorage.getItem(hiddenKeyForDevice(deviceId)) || "[]"));
    }
    function saveHiddenSet(deviceId, setObj){
      localStorage.setItem(hiddenKeyForDevice(deviceId), JSON.stringify(Array.from(setObj)));
    }

    /* =========================================================
       NEW: alert classification (message -> type + label + emoji)
       ========================================================= */
    function classifyAlert(msgRaw){
      const msg = String(msgRaw || "").toLowerCase();

      // online/system heartbeat
      if (msg.includes("online") || msg.includes("connected") || msg.includes("system: online") || msg.includes("tiva alert system")){
        return { type: "online", label: "System", emoji: "âœ…" };
      }

      // gas/smoke
      if (msg.includes("gas") || msg.includes("smoke") || msg.includes("co") || msg.includes("carbon")){
        return { type: "gas", label: "Gas/Smoke", emoji: "ðŸ›‘" };
      }

      // water/flood/leak
      if (msg.includes("water") || msg.includes("flood") || msg.includes("leak")){
        return { type: "water", label: "Water", emoji: "ðŸ’§" };
      }

      // temperature/heat
      if (msg.includes("temp") || msg.includes("temperature") || msg.includes("heat")){
        return { type: "temperature", label: "Temperature", emoji: "ðŸŒ¡ï¸" };
      }

      // vibration/motion/shock
      if (msg.includes("vibration") || msg.includes("vibrate") || msg.includes("motion") || msg.includes("shake") || msg.includes("impact")){
        return { type: "vibration", label: "Vibration", emoji: "ðŸ“³" };
      }

      // default
      return { type: "info", label: "Alert", emoji: "ðŸ””" };
    }

    function renderItems(deviceId, items) {
      listEl.innerHTML = "";
      const hiddenKeys = loadHiddenSet(deviceId);
      const visible = items.filter(x => !hiddenKeys.has(x.key));

      if (visible.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      for (const item of visible) {
        const klass = classifyAlert(item.msg);

        const card = document.createElement("div");
        card.className = `card alertCard alert--${klass.type}`;

        // NEW: top row with badge + time
        const top = document.createElement("div");
        top.className = "alertTop";

        const badge = document.createElement("span");
        badge.className = "alertBadge";
        badge.innerHTML = `<span class="emoji">${klass.emoji}</span> ${klass.label}`;

        const time = document.createElement("span");
        time.className = "muted small";
        time.textContent = formatTs(item.ts);

        top.appendChild(badge);
        top.appendChild(time);

        const msg = document.createElement("p");
        msg.className = "msg";
        msg.textContent = item.msg || "(no message)";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="muted">id: <span class="mono">${item.key}</span></span>
          <span class="muted">${klass.type}</span>
        `;

        const btnRow = document.createElement("div");
        btnRow.className = "btnrow";

        const hideBtn = document.createElement("button");
        hideBtn.textContent = "Hide";
        hideBtn.onclick = () => {
          hiddenKeys.add(item.key);
          saveHiddenSet(deviceId, hiddenKeys);
          loadAlertsForSelectedDevice();
        };

        btnRow.appendChild(hideBtn);

        card.appendChild(top);
        card.appendChild(msg);
        card.appendChild(meta);
        card.appendChild(btnRow);

        listEl.appendChild(card);
      }
    }

    function fillSelect(selectEl, ids, emptyText){
      selectEl.innerHTML = "";
      if (!ids || ids.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = emptyText;
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
      }
      selectEl.disabled = false;
      for (const id of ids.sort()){
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = id;
        selectEl.appendChild(opt);
      }
    }

    async function loadDevicesForUser(uid){
      deviceSelect.innerHTML = "";
      const snap = await get(ref(db, `users/${uid}/devices`));
      const val = snap.exists() ? snap.val() : null;

      const ids = val ? Object.keys(val) : [];

      fillSelect(deviceSelect, ids, "No devices paired yet");

      fillSelect(deleteDeviceSelect, ids, "No devices to delete");
      deleteDeviceBtn.disabled = !(ids && ids.length);

      if (ids.length === 0){
        return;
      }
    }

    async function loadAlertsForSelectedDevice() {
      const user = auth.currentUser;
      if (!user) {
        renderItems("none", []);
        setStatus("Please log in", "warn");
        return;
      }

      const deviceId = deviceSelect.value;
      if (!deviceId) {
        renderItems("none", []);
        setStatus("No device selected", "warn");
        return;
      }

      try {
        setStatus(`Loading alerts for ${deviceId}â€¦`, "muted");

        const q = query(
          ref(db, `alerts/${deviceId}`),
          orderByChild("ts"),
          limitToLast(MAX_ITEMS)
        );

        const snap = await get(q);
        if (!snap.exists()) {
          renderItems(deviceId, []);
          setStatus(`Connected â€¢ ${deviceId} (no alerts)`, "ok");
          return;
        }

        const data = snap.val();
        const items = Object.entries(data).map(([key, val]) => ({
          key,
          msg: val?.msg ?? "",
          ts: val?.ts ?? 0
        }));

        items.sort((a,b) => Number(b.ts||0) - Number(a.ts||0));
        renderItems(deviceId, items);
        setStatus(`Connected â€¢ ${deviceId} â€¢ ${items.length} shown`, "ok");
      } catch (e){
        console.error(e);
        setStatus("Error loading alerts", "error");
      }
    }

    // --------------------------
    // Auth actions (Login / Signup)
    // --------------------------
    document.getElementById("goSignupBtn").onclick = () => {
      setAuthMsg("", "muted");
      showAuthView("signup");
      document.getElementById("signupEmail").value = document.getElementById("loginEmail").value.trim();
    };

    document.getElementById("backToLoginBtn").onclick = () => {
      setAuthMsg("", "muted");
      showAuthView("login");
      document.getElementById("loginEmail").value = document.getElementById("signupEmail").value.trim();
    };

    document.getElementById("loginBtn").onclick = async () => {
      try {
        setAuthMsg("Logging inâ€¦", "muted");
        const email = document.getElementById("loginEmail").value.trim();
        const pass  = document.getElementById("loginPassword").value;
        await signInWithEmailAndPassword(auth, email, pass);
        setAuthMsg("Logged in.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Login failed", "error");
      }
    };

    document.getElementById("signupBtn").onclick = async () => {
      try {
        const email = document.getElementById("signupEmail").value.trim();
        const pass1 = document.getElementById("signupPassword").value;
        const pass2 = document.getElementById("signupPassword2").value;

        if (!email || !pass1 || !pass2){
          setAuthMsg("Please fill out all signup fields.", "warn");
          return;
        }
        if (pass1.length < 6){
          setAuthMsg("Password must be at least 6 characters.", "warn");
          return;
        }
        if (pass1 !== pass2){
          setAuthMsg("Passwords do not match.", "warn");
          return;
        }

        setAuthMsg("Creating accountâ€¦", "muted");
        await createUserWithEmailAndPassword(auth, email, pass1);
        setAuthMsg("Account created & logged in.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Signup failed", "error");
      }
    };

    document.getElementById("resetBtn").onclick = async () => {
      try {
        const email = document.getElementById("resetEmail").value.trim();
        if (!email) {
          setAuthMsg("Enter your email to reset the password.", "warn");
          return;
        }
        setAuthMsg("Sending reset emailâ€¦", "muted");
        await sendPasswordResetEmail(auth, email);
        setAuthMsg("Reset email sent. Check your inbox/spam.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Reset failed", "error");
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // --------------------------
    // Pair device
    // --------------------------
    document.getElementById("pairBtn").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const deviceId = document.getElementById("deviceId").value.trim();
      const pairCode = document.getElementById("pairCode").value.trim();

      if (!deviceId || !pairCode){
        setAuthMsg("Enter Device ID and Pairing Code.", "warn");
        return;
      }

      try {
        setAuthMsg("Pairing deviceâ€¦", "muted");

        await set(ref(db, `users/${user.uid}/devices/${deviceId}`), {
          pairedAt: Date.now(),
          code: pairCode
        });

        setAuthMsg(`Paired ${deviceId}.`, "ok");
        await loadDevicesForUser(user.uid);
        deviceSelect.value = deviceId;

        if (!deleteDeviceSelect.disabled) deleteDeviceSelect.value = deviceId;

        await loadAlertsForSelectedDevice();
      } catch (e){
        console.error(e);
        setAuthMsg(
          "Pairing failed. Check Device ID and Pairing Code (or device not registered yet).",
          "error"
        );
      }
    };

    document.getElementById("reloadDevicesBtn").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;
      await loadDevicesForUser(user.uid);
      await loadAlertsForSelectedDevice();
    };

    deviceSelect.onchange = loadAlertsForSelectedDevice;

    // --------------------------
    // Delete paired device
    // --------------------------
    deleteDeviceBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const idToDelete = (deleteDeviceSelect.value || "").trim();
      if (!idToDelete){
        setAuthMsg("No device selected to delete.", "warn");
        return;
      }

      const ok = confirm(`Remove "${idToDelete}" from your paired devices?\n\nThis will remove access to its alerts for your account (it does not delete alerts in the database).`);
      if (!ok) return;

      try {
        setAuthMsg(`Deleting ${idToDelete}â€¦`, "muted");
        await remove(ref(db, `users/${user.uid}/devices/${idToDelete}`));

        await loadDevicesForUser(user.uid);

        if (deviceSelect.value === idToDelete){
          const first = deviceSelect.options.length ? deviceSelect.options[0].value : "";
          deviceSelect.value = first || "";
        }

        if (!deleteDeviceSelect.disabled){
          deleteDeviceSelect.value = deviceSelect.value || deleteDeviceSelect.options[0]?.value || "";
        }

        await loadAlertsForSelectedDevice();
        setAuthMsg(`Deleted ${idToDelete}.`, "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Delete failed", "error");
      }
    };

    // --------------------------
    // Buttons for alerts UI
    // --------------------------
    document.getElementById("refreshBtn").onclick = loadAlertsForSelectedDevice;

    document.getElementById("clearLocalBtn").onclick = () => {
      const user = auth.currentUser;
      const deviceId = deviceSelect.value;
      if (!user || !deviceId) return;

      const keys = [];
      listEl.querySelectorAll(".card .meta .mono").forEach(el => keys.push(el.textContent.trim()));
      const hidden = loadHiddenSet(deviceId);
      keys.forEach(k => hidden.add(k));
      saveHiddenSet(deviceId, hidden);
      loadAlertsForSelectedDevice();
    };

    // ---------- Theme (Night Mode) ----------
    const THEME_KEY = "alertsTheme";
    const themeBtn = document.getElementById("themeBtn");

    function applyTheme(mode) {
      const isDark = (mode === "dark");
      document.body.classList.toggle("dark", isDark);
      themeBtn.textContent = `Night mode: ${isDark ? "On" : "Off"}`;
      localStorage.setItem(THEME_KEY, mode);
    }

    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "dark" || saved === "light") {
        applyTheme(saved);
        return;
      }
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(prefersDark ? "dark" : "light");
    })();

    themeBtn.onclick = () => {
      const currentlyDark = document.body.classList.contains("dark");
      applyTheme(currentlyDark ? "light" : "dark");
    };
    // --------------------------------------

    // --------------------------
    // Auth state handler
    // --------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        userLabelEl.textContent = "â€”";
        logoutBtn.style.display = "none";

        showAuthView("login");

        deviceSelect.innerHTML = "";
        deleteDeviceSelect.innerHTML = "";
        deleteDeviceBtn.disabled = true;

        setStatus("Please log in", "warn");
        setAuthMsg("Log in to view alerts.", "muted");
        renderItems("none", []);
        return;
      }

      userLabelEl.textContent = user.email || user.uid;
      logoutBtn.style.display = "inline-block";

      loginView.style.display = "none";
      signupView.style.display = "none";
      pairPanel.style.display = "block";

      setAuthMsg("Logged in. Pair a device or select one.", "ok");

      await loadDevicesForUser(user.uid);
      await loadAlertsForSelectedDevice();
    });

    // Auto refresh
    setInterval(loadAlertsForSelectedDevice, REFRESH_SECONDS * 1000);
  </script>
</body>
</html>
