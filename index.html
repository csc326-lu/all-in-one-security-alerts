<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Security Alerts</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alerts">

  <style>
    :root{
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --pill-bg: #eef2ff;
      --pill-text: #3730a3;
      --btn-bg: #ffffff;
      --btn-border: #d1d5db;
      --btn-text: #111827;
      --error: #b91c1c;
      --ok: #065f46;
      --warn: #92400e;

      /* alert type colors (light mode) */
      --alert-info: #2563eb;       /* blue */
      --alert-online: #16a34a;     /* green */
      --alert-vibration: #9333ea;  /* purple */
      --alert-temperature: #ea580c;/* orange */
      --alert-water: #0284c7;      /* cyan/blue */
      --alert-gas: #dc2626;        /* red */
    }

    body.dark {
      --bg: #0b1220;
      --surface: #0f172a;
      --border: #243044;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --pill-bg: #1f2937;
      --pill-text: #c7d2fe;
      --btn-bg: #0b1220;
      --btn-border: #243044;
      --btn-text: #e5e7eb;
      --error: #fca5a5;
      --ok: #86efac;
      --warn: #fbbf24;

      /* alert type colors (dark mode) */
      --alert-info: #60a5fa;
      --alert-online: #4ade80;
      --alert-vibration: #c084fc;
      --alert-temperature: #fb923c;
      --alert-water: #38bdf8;
      --alert-gas: #f87171;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      background: var(--surface);
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      z-index: 5;
    }
    h1 { margin: 0; font-size: 18px; }
    .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-text);
      font-size: 12px;
      border: 1px solid var(--border);
      white-space: nowrap;
    }

    main { padding: 12px 12px 24px; max-width: 1200px; margin: 0 auto; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 1040px){
      .grid { grid-template-columns: 360px 1fr 380px; align-items: start; }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .msg { font-size: 15px; margin: 0 0 8px; }
    .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btnrow { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button {
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    button:active { transform: scale(0.99); }
    button.primary { background: var(--pill-bg); border-color: var(--border); }
    button.danger { border-color: #ef4444; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    input, select {
      width: 100%;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
    }
    label { display: block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }

    .error { color: var(--error); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .muted { color: var(--muted); }
    .empty { text-align: center; padding: 28px 12px; color: var(--muted); }

    .divider { height: 1px; background: var(--border); margin: 12px 0; }

    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .linkbtn{
      background: none;
      border: none;
      padding: 0;
      color: var(--pill-text);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
    }

    /* =========================================================
       Distinct alert styling
       ========================================================= */
    .alertCard{
      position: relative;
      border-left: 6px solid var(--border);
    }
    .alertTop{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .alertBadge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--pill-bg);
      color: var(--pill-text);
      white-space: nowrap;
    }
    .alertBadge .emoji{ font-size: 14px; line-height: 1; }

    /* Type-specific: border + subtle tint */
    .alert--info{ border-left-color: var(--alert-info); background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(0,0,0,0) 45%); }
    body.dark .alert--info{ background: linear-gradient(90deg, rgba(96,165,250,0.10), rgba(0,0,0,0) 45%); }

    .alert--online{ border-left-color: var(--alert-online); background: linear-gradient(90deg, rgba(22,163,74,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--online{ background: linear-gradient(90deg, rgba(74,222,128,0.10), rgba(0,0,0,0) 45%); }

    .alert--vibration{ border-left-color: var(--alert-vibration); background: linear-gradient(90deg, rgba(147,51,234,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--vibration{ background: linear-gradient(90deg, rgba(192,132,252,0.10), rgba(0,0,0,0) 45%); }

    .alert--temperature{ border-left-color: var(--alert-temperature); background: linear-gradient(90deg, rgba(234,88,12,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--temperature{ background: linear-gradient(90deg, rgba(251,146,60,0.10), rgba(0,0,0,0) 45%); }

    .alert--water{ border-left-color: var(--alert-water); background: linear-gradient(90deg, rgba(2,132,199,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--water{ background: linear-gradient(90deg, rgba(56,189,248,0.10), rgba(0,0,0,0) 45%); }

    .alert--gas{ border-left-color: var(--alert-gas); background: linear-gradient(90deg, rgba(220,38,38,0.10), rgba(0,0,0,0) 45%); }
    body.dark .alert--gas{ background: linear-gradient(90deg, rgba(248,113,113,0.10), rgba(0,0,0,0) 45%); }

    /* =========================================================
       Clickable alerts
       ========================================================= */
    .alertClickable{
      cursor: pointer;
    }
    .alertClickable:hover{
      filter: brightness(0.99);
    }
    body.dark .alertClickable:hover{
      filter: brightness(1.05);
    }

    /* =========================================================
       NEW: Chart panel
       ========================================================= */
    #chartCol { display:none; }
    @media (min-width: 1040px){
      #chartCol { display:block; }
      #chartCol.hiddenWide { display:none; }
    }
    .chartHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .chartControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chartCanvasWrap{
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--bg);
      padding: 8px;
    }
    canvas{
      width: 100%;
      height: 240px;
      display:block;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin:10px 0 0;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <header>
    <h1>Security Alerts</h1>
    <div class="sub">
      <div id="status" class="pill muted">Loading‚Ä¶</div>
      <div class="pill">Auto refresh: <span id="intervalLabel">2</span>s</div>
      <div class="pill">User: <span id="userLabel" class="mono">‚Äî</span></div>
    </div>

    <div class="btnrow">
      <button id="refreshBtn">Refresh now</button>
      <button id="clearLocalBtn" title="Hides alerts locally (does not delete Firebase)">Clear on screen</button>
      <button id="themeBtn" title="Toggle night mode">Night mode: Off</button>
      <button id="logoutBtn" class="danger" style="margin-left:auto; display:none;">Log out</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Auth + Pairing -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Account</h3>

        <!-- LOGIN VIEW -->
        <div id="loginView">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="name@example.com" autocomplete="email"/>

          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>

          <div class="btnrow">
            <button id="loginBtn" class="primary">Log in</button>
            <button id="goSignupBtn">Create account</button>
          </div>

          <div class="divider"></div>

          <label>Forgot password?</label>
          <input id="resetEmail" type="email" placeholder="Email to send reset link" autocomplete="email"/>
          <div class="btnrow">
            <button id="resetBtn">Send reset email</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            Password reset uses Firebase Auth email reset (free). Check spam/junk folders.
          </p>
        </div>

        <!-- SIGNUP VIEW -->
        <div id="signupView" style="display:none;">
          <p class="small muted" style="margin:0 0 8px;">
            Create a new account for the alerts dashboard.
          </p>

          <label>Email</label>
          <input id="signupEmail" type="email" placeholder="name@example.com" autocomplete="email"/>

          <label>Password</label>
          <input id="signupPassword" type="password" placeholder="Create a password" autocomplete="new-password"/>

          <label>Confirm Password</label>
          <input id="signupPassword2" type="password" placeholder="Confirm password" autocomplete="new-password"/>

          <div class="btnrow">
            <button id="signupBtn" class="primary">Create account</button>
            <button id="backToLoginBtn">Back to login</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            After creating an account, you will be logged in automatically.
          </p>
        </div>

        <!-- PAIRED / LOGGED-IN PANEL -->
        <div id="pairPanel" style="display:none;">
          <h3 style="margin:0 0 8px;">Pair a device</h3>
          <p class="small muted" style="margin:0 0 8px;">
            Enter the Device ID + Pairing Code shown on the ESP8266 AP page.
          </p>

          <label>Device ID</label>
          <input id="deviceId" placeholder="Example: SystemA" />

          <label>Pairing Code</label>
          <input id="pairCode" placeholder="Example: 839201" />

          <div class="btnrow">
            <button id="pairBtn" class="primary">Pair device</button>
          </div>

          <div class="divider"></div>

          <label>Your paired devices</label>
          <select id="deviceSelect"></select>

          <div class="btnrow">
            <button id="reloadDevicesBtn">Reload devices</button>
          </div>

          <p class="small muted" style="margin:10px 0 0;">
            Pairing is saved to your account in Firebase, so you can log out/in and keep access.
          </p>

          <!-- Manage/Delete paired devices -->
          <div class="divider"></div>

          <h3 style="margin:0 0 8px;">Manage paired devices</h3>
          <p class="small muted" style="margin:0 0 8px;">
            Deleting a device here removes it from <span class="mono">your account</span> only. It does not delete alerts in Firebase.
          </p>

          <label>Delete a paired device</label>
          <select id="deleteDeviceSelect"></select>

          <div class="btnrow">
            <button id="deleteDeviceBtn" class="danger">Delete device</button>
          </div>
        </div>

        <div class="divider"></div>
        <p id="authMsg" class="small muted" style="margin:0;"></p>
      </div>

      <!-- MIDDLE: Alerts -->
      <div>
        <!-- Filter bar (shows when you click an alert) -->
        <div id="filterBar" class="card" style="display:none; margin-bottom:12px;">
          <div class="alertTop" style="margin-bottom:0;">
            <span id="filterBadge" class="alertBadge"><span class="emoji">üîé</span> Sensor</span>
            <button id="clearFilterBtn" class="primary">Show all alerts</button>
          </div>
          <p class="small muted" style="margin:10px 0 0;">
            Showing alerts for the selected sensor type over time (newest first).
          </p>
        </div>

        <div id="list"></div>
        <div id="empty" class="empty" style="display:none;">
          No alerts yet.<br><br>
          Trigger your system or wait for the next alert.
        </div>
      </div>

      <!-- RIGHT: Chart (third column) -->
      <div id="chartCol" class="card hiddenWide">
        <div class="chartHeader">
          <span id="chartTitle" class="alertBadge"><span class="emoji">üìà</span> Sensor chart</span>
          <button id="closeChartBtn" class="danger">Close</button>
        </div>

        <p class="small muted" style="margin:0 0 10px;">
          This graph shows alert <span class="mono">event counts</span> over time for the selected sensor on the currently selected device.
        </p>

        <div class="chartControls">
          <div style="flex:1; min-width:180px;">
            <label style="margin:0 0 6px;">Time range</label>
            <select id="chartRange">
              <option value="24h">Last 24 hours</option>
              <option value="7d" selected>Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="all">All (within loaded alerts)</option>
            </select>
          </div>
          <div style="flex:1; min-width:180px;">
            <label style="margin:0 0 6px;">Buckets</label>
            <select id="chartBucket">
              <option value="auto" selected>Auto</option>
              <option value="1h">1 hour</option>
              <option value="6h">6 hours</option>
              <option value="1d">1 day</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="chartCanvasWrap">
          <canvas id="chartCanvas" width="600" height="260"></canvas>
        </div>

        <div class="kpiRow">
          <span id="kpiCount">‚Äî</span>
          <span id="kpiFromTo">‚Äî</span>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // Firebase SDK (v10 modular) via CDN modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getDatabase,
      ref,
      get,
      set,
      remove,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ========= YOUR FIREBASE WEB CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyBk7o8KHY3qH3kCy-566j4_UKna8qkF0fM",
      authDomain: "all-in-one-security-system.firebaseapp.com",
      databaseURL: "https://all-in-one-security-system-default-rtdb.firebaseio.com",
      projectId: "all-in-one-security-system",
      storageBucket: "all-in-one-security-system.firebasestorage.app",
      messagingSenderId: "503460021077",
      appId: "1:503460021077:web:ffbaa186aeb34a749ce5dc"
    };

    // ========= UI CONFIG =========
    let REFRESH_SECONDS = 2;
    const MAX_ITEMS = 50;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const intervalLabelEl = document.getElementById("intervalLabel");
    const userLabelEl = document.getElementById("userLabel");
    const logoutBtn = document.getElementById("logoutBtn");
    const authMsg = document.getElementById("authMsg");

    const loginView = document.getElementById("loginView");
    const signupView = document.getElementById("signupView");
    const pairPanel = document.getElementById("pairPanel");

    const deviceSelect = document.getElementById("deviceSelect");

    // delete UI refs
    const deleteDeviceSelect = document.getElementById("deleteDeviceSelect");
    const deleteDeviceBtn = document.getElementById("deleteDeviceBtn");

    // filter UI refs
    const filterBar = document.getElementById("filterBar");
    const filterBadge = document.getElementById("filterBadge");
    const clearFilterBtn = document.getElementById("clearFilterBtn");

    // chart UI refs
    const chartCol = document.getElementById("chartCol");
    const chartTitle = document.getElementById("chartTitle");
    const closeChartBtn = document.getElementById("closeChartBtn");
    const chartRange = document.getElementById("chartRange");
    const chartBucket = document.getElementById("chartBucket");
    const chartCanvas = document.getElementById("chartCanvas");
    const kpiCount = document.getElementById("kpiCount");
    const kpiFromTo = document.getElementById("kpiFromTo");

    // keep last loaded alerts so we can re-render filtered view without refetching
    let lastLoaded = { deviceId: "", items: [] };
    // current sensor filter (klass.type) or null for all
    let currentSensorFilter = null;

    // current chart selection (klass data) or null
    let currentChart = null;

    intervalLabelEl.textContent = REFRESH_SECONDS;

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.classList.remove("error", "ok", "muted", "warn");
      statusEl.classList.add(kind || "muted");
    }

    function setAuthMsg(text, kind){
      authMsg.textContent = text || "";
      authMsg.classList.remove("error","ok","muted","warn");
      authMsg.classList.add(kind || "muted");
    }

    function showAuthView(which){
      // which = "login" | "signup"
      if (which === "signup"){
        loginView.style.display = "none";
        signupView.style.display = "block";
      } else {
        signupView.style.display = "none";
        loginView.style.display = "block";
      }
      pairPanel.style.display = "none";
    }

    function formatTs(ts) {
      const n = Number(ts);
      if (!isFinite(n) || n <= 0) return "time unknown";
      const ms = (n > 1577836800) ? (n * 1000) : n; // epoch seconds -> ms
      const d = new Date(ms);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    }

    function tsToMs(ts){
      const n = Number(ts);
      if (!isFinite(n) || n <= 0) return 0;
      return (n > 1577836800) ? (n * 1000) : n;
    }

    // ---------- Local hide (per device) ----------
    function hiddenKeyForDevice(deviceId){ return `hiddenAlertKeys:${deviceId}`; }
    function loadHiddenSet(deviceId){
      return new Set(JSON.parse(localStorage.getItem(hiddenKeyForDevice(deviceId)) || "[]"));
    }
    function saveHiddenSet(deviceId, setObj){
      localStorage.setItem(hiddenKeyForDevice(deviceId), JSON.stringify(Array.from(setObj)));
    }

    /* =========================================================
       alert classification (message -> type + label + emoji)
       ========================================================= */
    function classifyAlert(msgRaw){
      const msg = String(msgRaw || "").toLowerCase();

      // online/system heartbeat
      if (msg.includes("online") || msg.includes("connected") || msg.includes("system: online") || msg.includes("tiva alert system")){
        return { type: "online", label: "System", emoji: "‚úÖ" };
      }

      // gas/smoke
      if (msg.includes("gas") || msg.includes("smoke") || msg.includes("co") || msg.includes("carbon")){
        return { type: "gas", label: "Gas/Smoke", emoji: "üõë" };
      }

      // water/flood/leak
      if (msg.includes("water") || msg.includes("flood") || msg.includes("leak")){
        return { type: "water", label: "Water", emoji: "üíß" };
      }

      // temperature/heat
      if (msg.includes("temp") || msg.includes("temperature") || msg.includes("heat")){
        return { type: "temperature", label: "Temperature", emoji: "üå°Ô∏è" };
      }

      // vibration/motion/shock
      if (msg.includes("vibration") || msg.includes("vibrate") || msg.includes("motion") || msg.includes("shake") || msg.includes("impact")){
        return { type: "vibration", label: "Vibration", emoji: "üì≥" };
      }

      // default
      return { type: "info", label: "Alert", emoji: "üîî" };
    }

    // filter bar helpers
    function applySensorFilter(type, label, emoji){
      currentSensorFilter = type || null;

      if (!currentSensorFilter){
        filterBar.style.display = "none";
      } else {
        filterBar.style.display = "block";
        filterBadge.innerHTML = `<span class="emoji">${emoji || "üîé"}</span> ${label || type}`;
      }

      const deviceId = lastLoaded.deviceId || deviceSelect.value || "none";
      renderItems(deviceId, lastLoaded.items || []);
    }

    clearFilterBtn.onclick = () => applySensorFilter(null);

    /* =========================================================
       NEW: Chart helpers
       ========================================================= */
    function openChartForSensor(klass){
      currentChart = klass ? { ...klass } : null;

      if (!currentChart){
        closeChart();
        return;
      }

      chartCol.classList.remove("hiddenWide");

      chartTitle.innerHTML = `<span class="emoji">${currentChart.emoji || "üìà"}</span> ${currentChart.label || currentChart.type} chart`;

      // draw immediately from lastLoaded
      drawChartFromState();
    }

    function closeChart(){
      currentChart = null;
      chartCol.classList.add("hiddenWide");
      // keep canvas but clear KPIs
      kpiCount.textContent = "‚Äî";
      kpiFromTo.textContent = "‚Äî";
      clearCanvas();
    }

    closeChartBtn.onclick = closeChart;

    function clearCanvas(){
      const ctx = chartCanvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const cssW = chartCanvas.clientWidth || 600;
      const cssH = chartCanvas.clientHeight || 240;
      chartCanvas.width = Math.floor(cssW * dpr);
      chartCanvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height);
    }

    function getCssVar(name){
      return getComputedStyle(document.body).getPropertyValue(name).trim();
    }

    function pickBucketMs(rangeVal, bucketVal){
      if (bucketVal && bucketVal !== "auto"){
        if (bucketVal === "1h") return 60 * 60 * 1000;
        if (bucketVal === "6h") return 6 * 60 * 60 * 1000;
        if (bucketVal === "1d") return 24 * 60 * 60 * 1000;
      }
      // auto by range
      if (rangeVal === "24h") return 60 * 60 * 1000;          // 1h
      if (rangeVal === "7d") return 6 * 60 * 60 * 1000;       // 6h
      if (rangeVal === "30d") return 24 * 60 * 60 * 1000;     // 1d
      return 24 * 60 * 60 * 1000;                              // all -> 1d
    }

    function rangeStartMs(rangeVal, allMsSortedAsc){
      const now = Date.now();
      if (rangeVal === "24h") return now - 24 * 60 * 60 * 1000;
      if (rangeVal === "7d") return now - 7 * 24 * 60 * 60 * 1000;
      if (rangeVal === "30d") return now - 30 * 24 * 60 * 60 * 1000;
      // all: start at first event (within loaded alerts)
      return allMsSortedAsc.length ? allMsSortedAsc[0] : now - 7 * 24 * 60 * 60 * 1000;
    }

    function niceTimeLabel(ms){
      const d = new Date(ms);
      // short label: M/D HH or M/D
      const mo = d.getMonth() + 1;
      const da = d.getDate();
      const hh = d.getHours();
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${mo}/${da} ${hh}:${mm}`;
    }

    function drawChartFromState(){
      if (!currentChart) return;

      const deviceId = lastLoaded.deviceId || deviceSelect.value || "";
      const hidden = loadHiddenSet(deviceId);
      const type = currentChart.type;

      // Use loaded alerts, respect "hidden" keys
      const points = (lastLoaded.items || [])
        .filter(x => x && x.key && !hidden.has(x.key))
        .filter(x => classifyAlert(x.msg).type === type)
        .map(x => tsToMs(x.ts))
        .filter(ms => ms > 0)
        .sort((a,b) => a-b);

      const rangeVal = chartRange.value;
      const bucketMs = pickBucketMs(rangeVal, chartBucket.value);
      const startMs = rangeStartMs(rangeVal, points);
      const endMs = Date.now();

      // clamp to [startMs, endMs]
      const inRange = points.filter(ms => ms >= startMs && ms <= endMs);

      // make buckets
      const startAligned = Math.floor(startMs / bucketMs) * bucketMs;
      const endAligned = Math.ceil(endMs / bucketMs) * bucketMs;

      const bucketCount = Math.max(1, Math.min(4000, Math.round((endAligned - startAligned) / bucketMs)));
      const buckets = new Array(bucketCount).fill(0).map((_, i) => ({
        t: startAligned + i * bucketMs,
        y: 0
      }));

      for (const ms of inRange){
        const idx = Math.floor((ms - startAligned) / bucketMs);
        if (idx >= 0 && idx < buckets.length) buckets[idx].y += 1;
      }

      // KPIs
      kpiCount.textContent = `Events: ${inRange.length}`;
      const fromTxt = new Date(startMs).toLocaleString();
      const toTxt = new Date(endMs).toLocaleString();
      kpiFromTo.textContent = `Range: ${fromTxt} ‚Üí ${toTxt}`;

      // draw
      drawLineChart(buckets, type);
    }

    function drawLineChart(buckets, type){
      const ctx = chartCanvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;

      const cssW = chartCanvas.clientWidth || 600;
      const cssH = chartCanvas.clientHeight || 240;
      chartCanvas.width = Math.floor(cssW * dpr);
      chartCanvas.height = Math.floor(cssH * dpr);

      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      // colors
      const colorVar = `--alert-${type}`;
      const stroke = getCssVar(colorVar) || getCssVar("--alert-info") || "#2563eb";
      const border = getCssVar("--border") || "#e5e7eb";
      const text = getCssVar("--muted") || "#6b7280";

      const padL = 44, padR = 10, padT = 14, padB = 28;
      const w = cssW - padL - padR;
      const h = cssH - padT - padB;

      // axis + grid
      const maxY = Math.max(1, ...buckets.map(b => b.y));
      const yTicks = 4;

      ctx.lineWidth = 1;
      ctx.strokeStyle = border;

      // horizontal grid lines
      for (let i=0; i<=yTicks; i++){
        const y = padT + (h * i / yTicks);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + w, y);
        ctx.stroke();
      }

      // y labels
      ctx.fillStyle = text;
      ctx.font = "12px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      for (let i=0; i<=yTicks; i++){
        const v = Math.round(maxY * (1 - i / yTicks));
        const y = padT + (h * i / yTicks);
        ctx.fillText(String(v), padL - 8, y);
      }

      // x labels (start, mid, end)
      const t0 = buckets[0]?.t ?? Date.now();
      const tMid = buckets[Math.floor(buckets.length/2)]?.t ?? t0;
      const tEnd = buckets[buckets.length-1]?.t ?? t0;

      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(niceTimeLabel(t0), padL, padT + h + 8);

      ctx.textAlign = "center";
      ctx.fillText(niceTimeLabel(tMid), padL + w/2, padT + h + 8);

      ctx.textAlign = "right";
      ctx.fillText(niceTimeLabel(tEnd), padL + w, padT + h + 8);

      // plot line
      const xForI = (i) => padL + (w * (buckets.length === 1 ? 0 : i / (buckets.length - 1)));
      const yForVal = (val) => padT + (h * (1 - (val / maxY)));

      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2;
      ctx.beginPath();
      buckets.forEach((b, i) => {
        const x = xForI(i);
        const y = yForVal(b.y);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = stroke;
      buckets.forEach((b, i) => {
        const x = xForI(i);
        const y = yForVal(b.y);
        ctx.beginPath();
        ctx.arc(x, y, 2.5, 0, Math.PI*2);
        ctx.fill();
      });
    }

    // redraw chart on controls changes
    chartRange.onchange = drawChartFromState;
    chartBucket.onchange = drawChartFromState;

    // redraw on resize (so canvas stays crisp)
    window.addEventListener("resize", () => {
      if (currentChart) drawChartFromState();
    });

    function renderItems(deviceId, items) {
      listEl.innerHTML = "";
      const hiddenKeys = loadHiddenSet(deviceId);

      // Apply sensor filter (if set) + hidden filter
      const visible = items
        .filter(x => !hiddenKeys.has(x.key))
        .filter(x => {
          if (!currentSensorFilter) return true;
          const k = classifyAlert(x.msg);
          return k.type === currentSensorFilter;
        });

      if (visible.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      for (const item of visible) {
        const klass = classifyAlert(item.msg);

        const card = document.createElement("div");
        card.className = `card alertCard alert--${klass.type} alertClickable`;

        // Clicking the card:
        // 1) filters to that sensor type (existing behavior)
        // 2) opens the third-column chart for that sensor
        card.onclick = (ev) => {
          // If user clicked the Hide button (or inside it), do not filter/open
          if (ev.target && ev.target.closest && ev.target.closest("button")) return;
          applySensorFilter(klass.type, klass.label, klass.emoji);
          openChartForSensor(klass);
        };

        const top = document.createElement("div");
        top.className = "alertTop";

        const badge = document.createElement("span");
        badge.className = "alertBadge";
        badge.innerHTML = `<span class="emoji">${klass.emoji}</span> ${klass.label}`;

        const time = document.createElement("span");
        time.className = "muted small";
        time.textContent = formatTs(item.ts);

        top.appendChild(badge);
        top.appendChild(time);

        const msg = document.createElement("p");
        msg.className = "msg";
        msg.textContent = item.msg || "(no message)";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="muted">id: <span class="mono">${item.key}</span></span>
          <span class="muted">${klass.type}</span>
        `;

        const btnRow = document.createElement("div");
        btnRow.className = "btnrow";

        const hideBtn = document.createElement("button");
        hideBtn.textContent = "Hide";
        hideBtn.onclick = (ev) => {
          ev.stopPropagation(); // prevent card click
          hiddenKeys.add(item.key);
          saveHiddenSet(deviceId, hiddenKeys);
          loadAlertsForSelectedDevice();
        };

        btnRow.appendChild(hideBtn);

        card.appendChild(top);
        card.appendChild(msg);
        card.appendChild(meta);
        card.appendChild(btnRow);

        listEl.appendChild(card);
      }
    }

    function fillSelect(selectEl, ids, emptyText){
      selectEl.innerHTML = "";
      if (!ids || ids.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = emptyText;
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
      }
      selectEl.disabled = false;
      for (const id of ids.sort()){
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = id;
        selectEl.appendChild(opt);
      }
    }

    async function loadDevicesForUser(uid){
      deviceSelect.innerHTML = "";
      const snap = await get(ref(db, `users/${uid}/devices`));
      const val = snap.exists() ? snap.val() : null;

      const ids = val ? Object.keys(val) : [];

      fillSelect(deviceSelect, ids, "No devices paired yet");
      fillSelect(deleteDeviceSelect, ids, "No devices to delete");
      deleteDeviceBtn.disabled = !(ids && ids.length);

      if (ids.length === 0){
        return;
      }
    }

    async function loadAlertsForSelectedDevice() {
      const user = auth.currentUser;
      if (!user) {
        lastLoaded = { deviceId: "", items: [] };
        renderItems("none", []);
        setStatus("Please log in", "warn");
        return;
      }

      const deviceId = deviceSelect.value;
      if (!deviceId) {
        lastLoaded = { deviceId: "", items: [] };
        renderItems("none", []);
        setStatus("No device selected", "warn");
        return;
      }

      try {
        setStatus(`Loading alerts for ${deviceId}‚Ä¶`, "muted");

        const q = query(
          ref(db, `alerts/${deviceId}`),
          orderByChild("ts"),
          limitToLast(MAX_ITEMS)
        );

        const snap = await get(q);
        if (!snap.exists()) {
          lastLoaded = { deviceId, items: [] };
          renderItems(deviceId, []);
          setStatus(`Connected ‚Ä¢ ${deviceId} (no alerts)`, "ok");
          // If chart open, redraw (will be empty)
          if (currentChart) drawChartFromState();
          return;
        }

        const data = snap.val();
        const items = Object.entries(data).map(([key, val]) => ({
          key,
          msg: val?.msg ?? "",
          ts: val?.ts ?? 0
        }));

        items.sort((a,b) => Number(b.ts||0) - Number(a.ts||0));

        lastLoaded = { deviceId, items };

        renderItems(deviceId, items);
        setStatus(`Connected ‚Ä¢ ${deviceId} ‚Ä¢ ${items.length} shown`, "ok");

        // If chart open, update it with new data
        if (currentChart) drawChartFromState();
      } catch (e){
        console.error(e);
        setStatus("Error loading alerts", "error");
      }
    }

    // --------------------------
    // Auth actions (Login / Signup)
    // --------------------------
    document.getElementById("goSignupBtn").onclick = () => {
      setAuthMsg("", "muted");
      showAuthView("signup");
      document.getElementById("signupEmail").value = document.getElementById("loginEmail").value.trim();
    };

    document.getElementById("backToLoginBtn").onclick = () => {
      setAuthMsg("", "muted");
      showAuthView("login");
      document.getElementById("loginEmail").value = document.getElementById("signupEmail").value.trim();
    };

    document.getElementById("loginBtn").onclick = async () => {
      try {
        setAuthMsg("Logging in‚Ä¶", "muted");
        const email = document.getElementById("loginEmail").value.trim();
        const pass  = document.getElementById("loginPassword").value;
        await signInWithEmailAndPassword(auth, email, pass);
        setAuthMsg("Logged in.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Login failed", "error");
      }
    };

    document.getElementById("signupBtn").onclick = async () => {
      try {
        const email = document.getElementById("signupEmail").value.trim();
        const pass1 = document.getElementById("signupPassword").value;
        const pass2 = document.getElementById("signupPassword2").value;

        if (!email || !pass1 || !pass2){
          setAuthMsg("Please fill out all signup fields.", "warn");
          return;
        }
        if (pass1.length < 6){
          setAuthMsg("Password must be at least 6 characters.", "warn");
          return;
        }
        if (pass1 !== pass2){
          setAuthMsg("Passwords do not match.", "warn");
          return;
        }

        setAuthMsg("Creating account‚Ä¶", "muted");
        await createUserWithEmailAndPassword(auth, email, pass1);
        setAuthMsg("Account created & logged in.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Signup failed", "error");
      }
    };

    document.getElementById("resetBtn").onclick = async () => {
      try {
        const email = document.getElementById("resetEmail").value.trim();
        if (!email) {
          setAuthMsg("Enter your email to reset the password.", "warn");
          return;
        }
        setAuthMsg("Sending reset email‚Ä¶", "muted");
        await sendPasswordResetEmail(auth, email);
        setAuthMsg("Reset email sent. Check your inbox/spam.", "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Reset failed", "error");
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // --------------------------
    // Pair device
    // --------------------------
    document.getElementById("pairBtn").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const deviceId = document.getElementById("deviceId").value.trim();
      const pairCode = document.getElementById("pairCode").value.trim();

      if (!deviceId || !pairCode){
        setAuthMsg("Enter Device ID and Pairing Code.", "warn");
        return;
      }

      try {
        setAuthMsg("Pairing device‚Ä¶", "muted");

        // IMPORTANT: rules require fields: pc + pairedAt
        await set(ref(db, `users/${user.uid}/devices/${deviceId}`), {
          pairedAt: Date.now(),
          pc: pairCode
        });

        setAuthMsg(`Paired ${deviceId}.`, "ok");
        await loadDevicesForUser(user.uid);
        deviceSelect.value = deviceId;

        if (!deleteDeviceSelect.disabled) deleteDeviceSelect.value = deviceId;

        await loadAlertsForSelectedDevice();
      } catch (e){
        console.error(e);
        setAuthMsg(
          "Pairing failed. Check Device ID and Pairing Code (or device not registered yet).",
          "error"
        );
      }
    };

    document.getElementById("reloadDevicesBtn").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;
      await loadDevicesForUser(user.uid);
      await loadAlertsForSelectedDevice();
    };

    deviceSelect.onchange = async () => {
      // When switching devices, clear sensor filter so it doesn't look ‚Äúempty‚Äù
      applySensorFilter(null);
      // keep chart open, but it will redraw against the new device's loaded alerts after fetch
      await loadAlertsForSelectedDevice();
    };

    // --------------------------
    // Delete paired device
    // --------------------------
    deleteDeviceBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const idToDelete = (deleteDeviceSelect.value || "").trim();
      if (!idToDelete){
        setAuthMsg("No device selected to delete.", "warn");
        return;
      }

      const ok = confirm(`Remove "${idToDelete}" from your paired devices?\n\nThis will remove access to its alerts for your account (it does not delete alerts in the database).`);
      if (!ok) return;

      try {
        setAuthMsg(`Deleting ${idToDelete}‚Ä¶`, "muted");
        await remove(ref(db, `users/${user.uid}/devices/${idToDelete}`));

        await loadDevicesForUser(user.uid);

        if (deviceSelect.value === idToDelete){
          const first = deviceSelect.options.length ? deviceSelect.options[0].value : "";
          deviceSelect.value = first || "";
        }

        if (!deleteDeviceSelect.disabled){
          deleteDeviceSelect.value = deviceSelect.value || deleteDeviceSelect.options[0]?.value || "";
        }

        await loadAlertsForSelectedDevice();
        setAuthMsg(`Deleted ${idToDelete}.`, "ok");
      } catch (e){
        console.error(e);
        setAuthMsg(e.message || "Delete failed", "error");
      }
    };

    // --------------------------
    // Buttons for alerts UI
    // --------------------------
    document.getElementById("refreshBtn").onclick = loadAlertsForSelectedDevice;

    document.getElementById("clearLocalBtn").onclick = () => {
      const user = auth.currentUser;
      const deviceId = deviceSelect.value;
      if (!user || !deviceId) return;

      const keys = [];
      listEl.querySelectorAll(".card .meta .mono").forEach(el => keys.push(el.textContent.trim()));
      const hidden = loadHiddenSet(deviceId);
      keys.forEach(k => hidden.add(k));
      saveHiddenSet(deviceId, hidden);
      loadAlertsForSelectedDevice();
    };

    // ---------- Theme (Night Mode) ----------
    const THEME_KEY = "alertsTheme";
    const themeBtn = document.getElementById("themeBtn");

    function applyTheme(mode) {
      const isDark = (mode === "dark");
      document.body.classList.toggle("dark", isDark);
      themeBtn.textContent = `Night mode: ${isDark ? "On" : "Off"}`;
      localStorage.setItem(THEME_KEY, mode);

      // if chart is open, redraw with updated colors
      if (currentChart) drawChartFromState();
    }

    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "dark" || saved === "light") {
        applyTheme(saved);
        return;
      }
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(prefersDark ? "dark" : "light");
    })();

    themeBtn.onclick = () => {
      const currentlyDark = document.body.classList.contains("dark");
      applyTheme(currentlyDark ? "light" : "dark");
    };
    // --------------------------------------

    // --------------------------
    // Auth state handler
    // --------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        userLabelEl.textContent = "‚Äî";
        logoutBtn.style.display = "none";

        showAuthView("login");

        deviceSelect.innerHTML = "";
        deleteDeviceSelect.innerHTML = "";
        deleteDeviceBtn.disabled = true;

        // clear sensor filter UI/state on logout
        applySensorFilter(null);
        lastLoaded = { deviceId: "", items: [] };

        // close chart on logout
        closeChart();

        setStatus("Please log in", "warn");
        setAuthMsg("Log in to view alerts.", "muted");
        renderItems("none", []);
        return;
      }

      userLabelEl.textContent = user.email || user.uid;
      logoutBtn.style.display = "inline-block";

      loginView.style.display = "none";
      signupView.style.display = "none";
      pairPanel.style.display = "block";

      setAuthMsg("Logged in. Pair a device or select one.", "ok");

      await loadDevicesForUser(user.uid);
      await loadAlertsForSelectedDevice();
    });

    // Auto refresh
    setInterval(loadAlertsForSelectedDevice, REFRESH_SECONDS * 1000);
  </script>
</body>
</html>
